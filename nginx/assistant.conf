# Personal Assistant — MCP Servers Nginx Config
#
# Place at: /etc/nginx/sites-available/assistant
# Enable:   sudo ln -s /etc/nginx/sites-available/assistant /etc/nginx/sites-enabled/
# TLS:      sudo certbot --nginx -d YOUR-DOMAIN
# Reload:   sudo nginx -s reload
#
# Routing:
#   https://YOUR-DOMAIN/journal-db/  → http://127.0.0.1:3333/
#   https://YOUR-DOMAIN/garmin/      → http://127.0.0.1:5555/
#   https://YOUR-DOMAIN/google/      → http://127.0.0.1:3000/
#   https://YOUR-DOMAIN/places/      → http://127.0.0.1:1111/
#   https://YOUR-DOMAIN/splitwise/   → http://127.0.0.1:4000/
#
# All MCP endpoints require header: X-MCP-Key: YOUR-SECRET
# Health endpoints (/journal-db/health, etc.) are unauthenticated for monitoring.
#
# MCP URL examples for Claude Code config:
#   https://YOUR-DOMAIN/journal-db/mcp
#   https://YOUR-DOMAIN/garmin/mcp

# Required for long API key strings in the map block
map_hash_bucket_size 128;

# API key validation — set MCP_API_KEY in .env.production and replace below.
# To update the key: change the value, reload nginx (sudo nginx -s reload).
map $http_x_mcp_key $mcp_authorized {
    default     0;
    "REPLACE_WITH_MCP_API_KEY"  1;
}

server {
    listen 80;
    server_name YOUR-DOMAIN;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name YOUR-DOMAIN;

    # TLS — certbot fills these in after `certbot --nginx`
    ssl_certificate     /etc/letsencrypt/live/YOUR-DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR-DOMAIN/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ── Shared proxy settings ─────────────────────────────────────────────
    # MCP uses Server-Sent Events for streaming — disable buffering globally
    proxy_http_version  1.1;
    proxy_set_header    Host $host;
    proxy_set_header    X-Real-IP $remote_addr;
    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto https;
    proxy_buffering     off;
    proxy_cache         off;
    proxy_read_timeout  300s;

    # ── Journal DB MCP ────────────────────────────────────────────────────
    location /journal-db/health {
        # Health check — no auth required
        proxy_pass http://127.0.0.1:3333/health;
    }
    location /journal-db/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:3333/;
    }

    # ── Garmin MCP ────────────────────────────────────────────────────────
    location /garmin/health {
        proxy_pass http://127.0.0.1:5555/health;
    }
    location /garmin/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:5555/;
    }

    # ── Google Workspace MCP ──────────────────────────────────────────────
    location /google/health {
        proxy_pass http://127.0.0.1:3000/health;
    }
    location /google/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:3000/;
    }

    # ── Google Places MCP ─────────────────────────────────────────────────
    location /places/health {
        proxy_pass http://127.0.0.1:1111/health;
    }
    location /places/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:1111/;
    }

    # ── Splitwise MCP ─────────────────────────────────────────────────────
    location /splitwise/health {
        proxy_pass http://127.0.0.1:4000/health;
    }
    location /splitwise/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:4000/;
    }

    # ── Catch-all ─────────────────────────────────────────────────────────
    location / {
        return 404 "Not found\n";
    }
}
