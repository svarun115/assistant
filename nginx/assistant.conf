# Personal Assistant — MCP Servers Nginx Config
#
# Place at: /etc/nginx/sites-available/assistant
# Enable:   sudo ln -s /etc/nginx/sites-available/assistant /etc/nginx/sites-enabled/
# TLS:      sudo certbot --nginx -d YOUR-DOMAIN  (fills in SSL blocks automatically)
# Reload:   sudo nginx -s reload
#
# Routing:
#   https://YOUR-DOMAIN/journal-db/mcp  → http://127.0.0.1:3333/mcp
#   https://YOUR-DOMAIN/garmin/mcp      → http://127.0.0.1:5555/mcp
#   https://YOUR-DOMAIN/google/mcp      → http://127.0.0.1:3000/mcp
#   https://YOUR-DOMAIN/places/mcp      → http://127.0.0.1:1111/mcp
#   https://YOUR-DOMAIN/splitwise/mcp   → http://127.0.0.1:4000/mcp
#
# All MCP endpoints require header: X-MCP-Key: YOUR-SECRET

# Required for long API key strings in the map block
map_hash_bucket_size 128;

map $http_x_mcp_key $mcp_authorized {
    default                     0;
    "REPLACE_WITH_MCP_API_KEY"  1;
}

server {
    listen 80;
    server_name YOUR-DOMAIN;
    # certbot will convert this to HTTPS redirect after `certbot --nginx`

    # ── Shared proxy settings ──────────────────────────────────────────
    proxy_http_version  1.1;
    proxy_set_header    Host $host;
    proxy_set_header    X-Real-IP $remote_addr;
    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering     off;
    proxy_cache         off;
    proxy_read_timeout  300s;

    # ── Journal DB MCP ─────────────────────────────────────────────────
    location /journal-db/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:3333/;
    }

    # ── Garmin MCP ─────────────────────────────────────────────────────
    location /garmin/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:5555/;
    }

    # ── Google Workspace MCP ───────────────────────────────────────────
    location /google/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:3000/;
    }

    # ── Google Places MCP ──────────────────────────────────────────────
    location /places/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:1111/;
    }

    # ── Splitwise MCP ──────────────────────────────────────────────────
    location /splitwise/ {
        if ($mcp_authorized = 0) { return 401 "Unauthorized\n"; }
        proxy_pass http://127.0.0.1:4000/;
    }

    location / {
        return 404 "Not found\n";
    }
}
